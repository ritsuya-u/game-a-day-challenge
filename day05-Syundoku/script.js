const app = document.getElementById("app");

/* =========================
   データ（ユーザー提供を原文尊重で収録）
========================= */

// 〇短文（そのまま。※全角・誤字も原文のまま）
const SHORT_QUESTIONS = [
  ["日本の首都は大阪である","いいえ"],
  ["一年は必ず三千百六十五日である","いいえ"],
  ["富士山は日本で二番目に高い山である","いいえ"],
  ["太陽は地球の周りを回っている","いいえ"],
  ["日本には四つの季節がある","はい"],
  ["月は自分で光を出している","いいえ"],
  ["日本の硬貨に穴の空いたものがある","はい"],
  ["桜は一年中咲いている","いいえ"],
  ["日本の国旗は赤と白でできている","はい"],
  ["一桁の素数は全部で四つある","はい"],
  ["二の倍数は必ず偶数である","はい"],
  ["三角形の内角の和は百八十度である","はい"],
  ["三は九の倍数である","いいえ"],
  ["一分は百秒である","いいえ"],
  ["一メートルは百センチである","はい"],
  ["十より大きい最小の素数は十一である","はい"],
  ["偶数と奇数の引き算の答えは必ず偶数である","いいえ"],
  ["ローマ字には音読みと訓読みがある","いいえ"],
  ["「走る」は動詞である","はい"],
  ["「大きい」は形容詞である","はい"],
  ["日本語に敬語は存在しない","いいえ"],
  ["犬は哺乳類である","はい"],
  ["魚は肺で呼吸する","いいえ"],
  ["血液は毛の中を流れている","いいえ"],
  ["体温は誰でも同じである","いいえ"],
  ["地球は太陽系の惑星である","はい"],
  ["地球には重力が存在する","はい"],
  ["日本は島鳥である","いいえ"],
  ["日本は赤道上に位置している","いいえ"],
  ["日本にはギザのピラミッドが存在する","いいえ"],
  ["光はまばたきの振動である","いいえ"],
  ["音は光より速く進む","いいえ"],
  ["日本の車道では左側通行である","はい"],
  ["信号の青は進んでよい合図である","はい"],
  ["一日は二十四時間である","はい"],
  ["日本では義務教育がある","はい"],
  ["英語には動詞の過去形がある","はい"],
  ["be動詞は動詞の一種である","はい"],
  ["朝日は西から昇る","いいえ"],
  ["日本には四十七の都道府県がある","はい"],
  ["日本の法律は一つしかない","いいえ"],
  ["選挙は日本にいれば誰でも参加できる","いいえ"],
  ["素数とは一とその数自身以外に約数を持たない数のことを指す","はい"],
  ["円周率は整数値で表すことができる","いいえ"],
  ["人間は哺乳類に分類され、体温を一定に保つ恒温動物である","はい"],
  ["人の心臓は全身に血液を送り出すポンプの役割を果たしている","はい"],
  ["天気予報は観測データをもとに予測されるが、必ず当たるとは限らない","はい"],
  ["自民党は存在しない","いいえ"],
  ["パーソナルコンピュータは略してPCRである","いいえ"],
];

// 〇長文（1〜11をそのまま）
const LONG_TEXTS = [
  {
    text: `テントウムシを見たことがありますか。
小さくてまるく、つやがあり、とてもきれいな色をしていますね。
また、テントウムシには、太陽にむかってとんでいくというとくちょうがあります。

では、テントウムシの「テントウ」とは何のことか知っていますか。
テントウは、漢字では「天道」と書き、太陽や太陽のみさまのことを言います。
よく太陽のことを「おてんとうさま」と言うでしょう。

このようなことからテントウムシという名前がついたのです。
（英・田吉「いきものの名まえ」による）`,
    qs: [
      ["筆者はテントウムシはとてもきれいな色をしていると思っている","はい"],
      ["筆者は太陽のことを「おてんとうさま」という言うのは高齢者だけと主張している","いいえ"],
      ["この文章全体の主旨は、筆者の好きな生物であるテントウムシの魅力を伝えることである","いいえ"],
    ],
  },
  {
    text: `わたしたちは、毎日の生活の中で、たくさんのごみを出します。
また、ごみにも、もやせるごみやもやせないごみ、かんやペットボトルなどのように、しげんとなるごみなど、さまざまな種類があります。
今、わたしたちのまわりでは、ごみを少しでもへらそうと、さまざまな取り組みが行われています。
 たとえば、買い物をしたときに、ふくろをもらわなかったり、使えるものはすてずに何回も使ったり、ごみをきちんとしゅるいべつに分けたりすることです。
 これだけでも、ごみをへらすことができるのです。
大切なのは、わたしたち一人一人が、ごみのことをしんけんに考え、へらすためにできることから始めることなのです。
（中林英純「くらしとごみ」より）`,
    qs: [
      ["筆者はごみにはさまざまな種類があると説明している","はい"],
      ["筆者はゴミを減らすための取り組みとしてリデュースやリユースの例を紹介している","はい"],
      ["この文章全体の主旨は、ごみを減らすために大切なことを説明することである","はい"],
    ],
  },
  {
    text: `ミミズは、おもに土を食べて生きています。
一日に、自分の体重の半分から同じくらいの量の土を食べるというのですから、おどろきです。
 食べた土は、ふんとなって体の外に出されます。
 ふんには、植物が育つためのえいようがたくさんふくまれています。
また、ミミズが土の中をきまわることで、すきまができ、空気や水の通りがよくなります。
 つまり、土をたがやすはたらきもしてくれているのです。
ミミズがげんきだと、土や植物もげんきになると言えるかもしれません。
（段野松子「自然にムダなんてない」による）`,
    qs: [
      ["筆者は、ミミズはおもに土を食べると説明している","はい"],
      ["筆者はミミズが一日に自分の体重の半分から同じくらいの量の土を食べると知っても驚かなかった","いいえ"],
      ["必殺は土や植物にとってミミズはよろしくないと考えている","いいえ"],
    ],
  },
  {
    text: `カワセミという鳥の名まえを知っている人は多いでしょう。
 けれど、この鳥を見たことのある人は、このごろではすくなくなっていると思います。
カワセミはその名のように、川にすんでいる鳥で、小さな川魚や、流れにすんでいる虫を食べて生きています。
 いる人がいますが、それは、この鳥がきれいな川にしかいないからです。
ちかごろ都市のまわりの川は、ひどくよごれています。
 川がよごれだすと、そこにすむ魚も種類がへりはじめます。
 カワセミのこのんで食べるウグイやオイカワの幼魚は、きれいな流れやふちにしかすめないので、川がよごれはじめると、カワセミはもっときれいな川にうつっていくのです。
（高橋健「ふるさとの川の番人カワセミ」より）`,
    qs: [
      ["筆者は近年カワセミを見たことあのある人は増えてきていると考えている","いいえ"],
      ["筆者は都市の周りの川はとても汚れていると感じている","はい"],
      ["この文章全体の主旨は、川の環境を守るために企業への法規制を進めるべきという主張である","いいえ"],
    ],
  },
  {
    text: `約束の時間を守らないで、他人に迷惑をかけることは悪いことであることは、だれもが認める。それなのに、どうして私たちはこんなに時間にだらしがないのだろうか。
 その理由は、私たち日本人は、時間をムダにしたり、ムダにされることにあまり細かく気にかけない性質であるからだと思われる。
十人の会合に、十分おくれてやってきた人は、他の九人の人たちから十分ずつ、合計九十分の時間をうばい取ったわけだが、当人はそれほど重大なあやまりをおかしたと思わず、十分ぐらいの時間のムダは、ほとんど気にかけない。これがいけないのだと思う。
これがお金だったら、人々はこんなにのん気にしているわけにはいかないだろう。つまり多くの日本人にとって、時間は、それをすぐお金のねうちにかえて考えるほど、大切ではないのだろう。しかし、自分にとって大切ではないからといって、他人もそうであると考えることはあやまりであろう。
だいたいに、時間を正確に守らないのは、いそがしすぎる人と、ひますぎる人に多いようである。前者は他人は自分ほどいそがしくないだろうから、少しぐらい待ってもらってもゆるされるだろうと考え、後者は他人にもひまな時間がとってもゆるされるだろうと考えるのである。どちらも自分中心の考え方であることはいうまでもない。
しかしこれからの若い人は、他人の時間を大切にすることを大いに学びつつあるようである。そうでなければ、まんぞくした共同生活を送ることはできなくなるであろう。それは人々がますますいそがしくなり、それだけに自分の時間をいよいよ大切にするようになるからである。
（河盛好蔵「人とつき合う法」より）`,
    qs: [
      ["筆者は日本人には時間を厳しく守る性質があると考えている","いいえ"],
      ["筆者は時間を正確に守らない人を大雑把に二パターンに分けている","はい"],
      ["筆者は日本人が時間にだらしない現状が変わると予感している","はい"],
    ],
  },
  {
    text: `花が、たくさん咲いている季節には、女王ばちは一日に一五〇〇個ぐらいの卵を昼も夜も産みつづけます。計算してみると、一分間に一個のはやさで産むのです。
 一五〇〇個の卵の重さは、女王ばちの体重（二〇〇～三〇〇ミリグラム）と同じぐらいになるといわれています。
不思議なことに、一日にいくつ卵を産むかは、女王ばちがきめるのではありません。外で働く働きばち、つまり、季節の変化を知っている働きばちがきめるのです。
「もうすぐ春が来るから、卵を産ませよう」
 「今、花ざかりだから、たくさん卵を産ませよう」
 「夏が近づいてきた。卵を産むのを止めさせよう」
きっとこんな話し合いが、働きばちのあいだでかわされるのでしょう。女王ばちは、つきそっている若い働きばちにつたえられます。
若い働きばちが、ローヤルゼリーを多く食べさせると、女王ばちはたくさんの卵を産みます。少し食べさせると、少ししか卵を産みません。
もし、花が咲いていない季節に、おなかの仲間が生まれてくると、みんないっしょにうえ死にしてしまうことを、みつばちは知っています。
私たち人間が平和な生活を続けていくためには、食べ物と人口との関係を、もっと、もっと、みつばちに教えてもらわねばなりません。
（大村光良「みつばちの家族は五〇〇〇びき」文研出版による）`,
    qs: [
      ["筆者はミツバチは一日に卵を百個産むと説明している","いいえ"],
      ["筆者は卵を産む個数は働きばちが決めると主張している","はい"],
      ["筆者は食糧不足について考えるヒントを読者に与えている","はい"],
    ],
  },
  {
    text: `わたしは、いまから十年あまりまえの春に、森のなかに小さな小屋をたてました。
 わたしが山小屋をたてた森は、自動車がいきかう国道から、十五分ほど歩いて山にはいった、スギとヒノキの森です。ちかくには、コナラの雑木林やアカマツの森もあります。このような変化のある森にすむ野ネズミの代表が、アカネズミとヒメネズミです。これらの野ネズミは、尾が、からだとおなじくらい長くて、すばやく動くことができます。そして、おもに木の実を食べてくらしています。
野ネズミは、とても小さな動物です。からだが小さいことには、よいことと、わるいことがあるようです。からだが小さいと、たくさんの動物にねらわれます。キツネやフクロウだけではありません。イタチやヘビなど、野ネズミを食べようとする動物がたくさんいるのです。森のなかでは、うかうかしてはいられません。
けれども、からだが小さいと、石の下、岩のわれめ、木の根もと、たおれた木の下、やぶのなか、それにモグラのトンネルのなかなど、森にあるたくさんのすきまに、かくれることができます。これが、からだが小さいことの、よいほうの意味なのです。
野ネズミたちは、ふだん、わたしたちの目に入らない小さなすきまを、じょうずにつかっているのです。
（今泉吉晴「野ネズミの森」より・一部省略）`,
    qs: [
      ["必殺は森の中に小さな小屋をたてたことがある","はい"],
      ["筆者は弱肉強食の残酷さについて例を通じて説明している","いいえ"],
      ["筆者は野生環境でからだは小さいと生き残れないから、なるべく大きいほうがいいと考えている","いいえ"],
    ],
  },
  {
    text: `近ごろは、真壁づくりの家が少なくなりました。木造建築が少なくなったためです。しかし、木造家屋を「大壁」というつくりにすることが多くなったせいもあります。大壁というのは、板や合板やビニールクロスで家の骨組みをおおい、柱を見えなくした壁のことです。大壁にすると、壁が家をささえている西洋の家に似てきます。
大壁が主流になったのは、人々の好みと生活様式が洋風になったためでしょう。しかしそれは、家のためには決して好ましいことではありません。日本は、高温多湿の季節がある国です。そういう国で、木材を通気性のない外装や内装の間にとじこめると、家をささえている大事な柱が、むれてヨワくなってしまうからです。日本に真壁づくりが生まれたのには、それなりのわけがあるのです。
木は、柱や板になってからも、生きて呼吸しています。ですから、イキがつくように、せめて家の中ぐらいは、柱をむき出しにしておいたほうがいい。十センチ角、長さ三メートルの柱一本は、ビールびん一本分の湿気を、吸ったり放出したりしています。柱をむき出しにしておけば、それだけの湿度を調節することができます。
住まいを近代化することと、洋風にすることとはちがいます。真壁づくりは、日本の風土に合った構造です。木の美しさや、大工さんの技術も生きてきます。壁は、合板や石こうに変えてもかまいません。しかし、柱を空気にふれさせる構造は、ぜひ復活してほしいものです。
（河津千代知「日本の自然と木の文化」より）`,
    qs: [
      ["筆者は建築の西洋化についてあまり好ましく思っていない","はい"],
      ["筆者は技術によって日本の風土に合わなくても大抵の建築ができるようになったと主張している","いいえ"],
      ["筆者は柱をむき出しにするのは柱の劣化を早めるため危ないと主張している","いいえ"],
    ],
  },
  {
    text: `大切なのは視線です。どこを見るかということです。特に、相手の目と視線を合わせることをこれはアイコンタクトといいます。
これは文化によって違います。たとえば、バングラデシュでは、目に対して下をむいたまま話をするそうです。日本でも、昔はどちらかというとそうだったようですし、今でも日本では、子供が親に怒られるとき、じっと親の目を見たりはしません。話を聞いているという印として、相手の目を時々見ますが、じっと見つめることは、むしろ反抗の気持ちを表すことになるのではないでしょうか。
一方、イギリスの人から聞いたのですが、小さいころ、親からしかられるとき、よく「私の目を見なさい！」と言われたといいます。相手の目を見ないことは、相手の話をきちんと聞かないということなのだそうです。
ただし、日本でも、相手と話をする場合には、きちんと思いを伝えるとき、時々は相手の目を見るのが普通のようです。学生時代、面接試験の時は、相手のネクタイのあたりを見なさい、と教えられましたが、自分が面接員になった時の個人的印象では、ぼんやりと目を合わせないままでいるよりは、時々は相手の目を見てしっかりアイコンタクトを取るほうが自信をもって話をしているような気がします。
前に自動車の販売をしている人から伺った話ですが、商談をする場合には、複数の相手がいれば、必ず、一人一人の目を見るように気をつけているそうです。相手の目を見ないで話をすると、まるでその人を無視しているような印象を与えてしまい、その人が気分を悪くする可能性があるからです。これは発表をする場合などでも同じなのではないでしょうか。話を聞いてくれる一人一人を大切にするという思いを、アイコンタクトによって表すことができるのです。これは大切なことです。
（森山卓郎「コミュニケーションの日本語」より）`,
    qs: [
      ["筆者はコミュニケーションをする上で大切なのはジェスチャーだと説明している","いいえ"],
      ["筆者はバングラデシュでは話をするときまっすぐに目をみると説明している","いいえ"],
      ["筆者はアイコンタクトの欠落により人の気分を害することがあると説明している","はい"],
    ],
  },
  {
    text: `強い日光に耐えられるように、「黒い眼」ができたことからもわかるように、日本は太陽がいっぱいの国です。日ざしをさえぎる構造になっている日本家屋は、暑さに悩まされてきた私たちの先祖が、長い歴史の中で考えに考えてつくり上げたものです。そういう住まいの伝統を無視して、鉛色の空の国の住宅にあこがれるのは、まちがっています。
どこの国の住宅も、それぞれの風土の中から生まれてきたものだからです。
箱型高層のオフィス・ビルは、日当たりという点では百点です。しかし、直射日光をもろにあびる部屋の夏の暑さは、二重ガラスにしても、カーテンを引いても、ブラインドをおろしても防げません。クーラーもききません。住宅でもそれは同じです。
一般的にいって、鉄筋コンクリートの建物は、夏の直射日光をあびると、外壁の温度が四十五度以上になります。屋上は六十度ちかく、その熱が伝わってくる室内の壁面は三〇度。コンクリートは熱をたくえる性質をもっているので、クーラーをとめると、こんどは中にたまった熱がはき出され、夜になってもなかなか涼しくなってきません。クーラーをつけっぱなしにしても、壁の内部まで温度を下げることはできません。
そして翌日、建物が冷えきらないうちに日がのぼり、真夏の太陽がまた一日中建物を熱しつづけます。そういうことがくり返されると、クーラーの排熱が加わるので、夏の都会は、熱のかたまりのようなヒート・アイランドになります。
なお悪いことに、クーラーは、暑さの悪循環をひきおこします。排熱のため、家の外では気温が上がります。そのために、クーラーなしではくらせない家がふえてゆく。すると、ますます気温が上がり、クーラーの数もふえつづける。その電気をつくるための石油などの燃料が燃やされ、地球温暖化が進行する、ということになるからです。
（河津千代知「日本の自然と木の文化」より）`,
    qs: [
      ["筆者は風土に合わない建築をすべきではないと考えている","はい"],
      ["筆者は日当たりがとてもいい建物を例に挙げている","はい"],
      ["筆者は近年はクーラーなどが発明され建物が風土に合わない問題は解決されたと説明している","いいえ"],
    ],
  },
  {
    text: `江戸のふつうの人びとは、今の人から見れば貧しくて、不便な暮らしをしていました。ところが、不便なために時間のゆとりが今よりあったのです。
たとえば大工さんは、朝は早くから働きはじめても、暗くなる前に仕事を終わりにしました。電灯がないので、暗くなるとこまかい作業ができないばかりか、木くずが散らばっているところで、ろうそくなどをつければ火事になる危険があるからです。明るいうちに家に帰った大工さんは、ゆっくりする時間がかなりあったのです。
また、江戸の面積の半分は田や畑で、農民がたくさんいましたが、農作物を育てるには手間のかかる時期と、かからない時期があって、手間のかからない農閑期は時間のゆとりがありました。
家賃や教育費が安かったため、ふだんはあまり長い時間働いてたくさんかせぐ必要がなかったのです。そのため、江戸ではいろいろな遊びに熱中する時間がたっぷりありました。さまざまな歌を習う、三味線などの楽器をひく、和歌や俳句などの詩を作る、仲間うちで芝居をする、絵をかく、花や観葉植物を育てる、遊山といって景色のいいところへ見物に行くなど、おとなの趣味はたくさんありました。
子どもたちも、今のような宿題や受験勉強などなかったので、手習いから帰ると、手つだいをしながらも、日がくれるまで外で友だちと遊びました。遊びの種類は、今の子どもよりはるかに多かったと思います。
（石川英輔「江戸のゆったりスローライフ」より）`,
    qs: [
      ["筆者は昔の人は明かりのない夜に作業できないため時間がなかったと主張している","いいえ"],
      ["筆者は昔は農業に時間がかかり遊ぶことができなかったと主張している","いいえ"],
      ["筆者は文化がが成熟した現代のほうが遊びの種類が多いと考えている","いいえ"],
    ],
  },
];

/* =========================
   画面用テキスト（要件の文章1〜6）
========================= */

const TEXTS = {
  // 短文：文章1〜3
  shortIntro1: `問題は一文字ずつ表示されます。
問題表示後、選択肢が表示されます。
準備はよろしいですか？`,
  shortIntro2Base: `それではいきます`,
  shortBetween: (n) => `問題${n}\nを表示します`,

  // 長文：文章4〜6
  longIntro4: `長文では、文章が表示されたあと、設問を表示します。
準備はよろしいですか？`,
  longAfterText6: `結果を表示します`,
  longQIntro5: (k) => `設問${k}を表示します`,
};

/* =========================
   共通ユーティリティ
========================= */

function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function clearApp(){
  app.innerHTML = "";
}

function make(el, props={}, ...children){
  const e = document.createElement(el);
  Object.assign(e, props);
  for(const c of children){
    if(typeof c === "string") e.appendChild(document.createTextNode(c));
    else if(c) e.appendChild(c);
  }
  return e;
}

function showCenter(contentEl){
  clearApp();
  const wrap = make("div");
  wrap.style.width = "min(760px, 100%)";
  wrap.style.margin = "0 auto";
  wrap.style.display = "flex";
  wrap.style.flexDirection = "column";
  wrap.style.alignItems = "center";
  wrap.style.gap = "16px";
  wrap.appendChild(contentEl);
  app.appendChild(wrap);
}

function showTextWithOK(text, onOK){
  const box = make("div");

  // 追加：縦並び＋余白
  box.style.display = "flex";
  box.style.flexDirection = "column";
  box.style.alignItems = "center";
  box.style.gap = "32px"; // ←ここでボタンとの距離が空く

  const p = make("div");
  p.style.whiteSpace = "pre-wrap";
  p.style.lineHeight = "1.7";
  p.textContent = text;

  const btn = make("button", { textContent:"OK" });
  btn.addEventListener("click", onOK);

  box.appendChild(p);
  box.appendChild(btn);
  showCenter(box);
}


function showYesNo(onPick){
  const box = make("div");
  box.style.display = "flex";
  box.style.gap = "16px";
  box.style.flexWrap = "wrap";
  box.style.justifyContent = "center";

  const yes = make("button", { textContent:"はい" });
  const no  = make("button", { textContent:"いいえ" });

  yes.addEventListener("click", ()=>onPick("はい"));
  no.addEventListener("click",  ()=>onPick("いいえ"));

  box.appendChild(yes);
  box.appendChild(no);
  showCenter(box);
}

function flashChars(text, speedMs, onDone){
  clearApp();
  const el = make("div");
  el.className = "char";
  el.style.whiteSpace = "pre-wrap";
  showCenter(el);

  let i = 0;
  const timer = setInterval(()=>{
    el.textContent = text[i] ?? "";
    i++;
    if(i > text.length){
      clearInterval(timer);
      setTimeout(onDone, 250);
    }
  }, speedMs);
}

function countdown3_2_1(onDone){
  clearApp();
  const el = make("div");
  el.className = "char";
  el.style.whiteSpace = "pre-wrap";
  showCenter(el);

  const seq = ["3","2","1"];
  let idx = 0;

  el.textContent = `${TEXTS.shortIntro2Base}\n\n${seq[idx]}`;
  const timer = setInterval(()=>{
    idx++;
    if(idx >= seq.length){
      clearInterval(timer);
      setTimeout(onDone, 250);
      return;
    }
    el.textContent = `${TEXTS.shortIntro2Base}\n\n${seq[idx]}`;
  }, 700);
}

/* =========================
   タイトル画面
========================= */

function showTitle(){
  const box = make("div");
  const h1 = make("h1", { textContent:"瞬読!!" });
  h1.className = "title-main";

  const sub = make("div", {
    className:"title-sub",
    textContent:"超高速で表示される問題に挑め!!"
  });

  const btnRow = make("div");
  btnRow.style.display = "flex";
  btnRow.style.gap = "16px";
  btnRow.style.flexWrap = "wrap";
  btnRow.style.justifyContent = "center";

  const shortBtn = make("button", { textContent:"短文" });
  const longBtn  = make("button", { textContent:"長文" });

  shortBtn.addEventListener("click", startShort);
  longBtn.addEventListener("click", startLong);

  btnRow.appendChild(shortBtn);
  btnRow.appendChild(longBtn);

  box.appendChild(h1);
  box.appendChild(sub);
  box.appendChild(btnRow);

  showCenter(box);
}

/* =========================
   短文モード
========================= */

let shortScore = 0;

function startShort(){
  shortScore = 0;

  // 50問想定（不足してても落ちないように）
  const pool = shuffle(SHORT_QUESTIONS);
  const total = Math.min(15, pool.length);
  const quiz = pool.slice(0, total);

  let speed = 90;           // 初期速度（ms/文字）※ここを好みで調整
  const accel = 5;          // 1問ごとに早く
  const minSpeed = 18;

  // 文章1 → OK → 文章2+カウントダウン → 問題1へ
  showTextWithOK(TEXTS.shortIntro1, ()=>{
    countdown3_2_1(()=>runShortQuestion(0));
  });

  function runShortQuestion(i){
    if(i >= quiz.length) return showShortResult(total);

    const [qText, correct] = quiz[i];

    flashChars(qText, speed, ()=>{
      showYesNo((pick)=>{
        if(pick === correct) shortScore++;
        speed = Math.max(minSpeed, speed - accel);

        // 文章3（問題n 準備OK）→ 次へ
        // 次の問題があるか？
if (i + 1 < quiz.length) {
  // 次に出す問題番号（人間用）
  const nextNo = i + 2;

  showTextWithOK(TEXTS.shortBetween(nextNo), () => {
    runShortQuestion(i + 1);
  });
} else {
  // もう次は無い → リザルト
  showShortResult(total);
}


      });
    });
  }
}

function showShortResult(total){
  const box = make("div");
  const h = make("h1", { textContent:"スコア" });
  const r = make("div", { className:"result", textContent:`${shortScore} / ${total}` });

  const back = make("button", { textContent:"タイトルへ" });
  back.addEventListener("click", showTitle);

  box.appendChild(h);
  box.appendChild(r);
  box.appendChild(back);

  showCenter(box);
}

/* =========================
   長文モード
========================= */

let longScore = 0;

function startLong(){
  longScore = 0;

  const chosen = shuffle(LONG_TEXTS).slice(0, 1); // 11個の文章からランダムに3個
  let textSpeed = 80;       // 文章ごとの表示速度（ms/文字）
  const textAccel = 0;      // 文章ごとに速くなる
  const minTextSpeed = 18;

  // 文章4 → OK → 文章表示開始
  showTextWithOK(TEXTS.longIntro4, ()=>runText(0));

  function runText(tIndex){
    if(tIndex >= chosen.length) return showLongResult();

    const pack = chosen[tIndex];

    // 文章表示（全文は出さずに一文字ずつ）
    flashChars(pack.text, textSpeed, ()=>{
      // 文章表示終了後 → 設問へ（文章5）
      runQuestion(tIndex, 0);
    });
  }

  function runQuestion(tIndex, qIndex){
    const pack = chosen[tIndex];

    if(qIndex >= pack.qs.length){
      // 3問終わったら文章6 → OK → 次の文章
      textSpeed = Math.max(minTextSpeed, textSpeed - textAccel);
      showTextWithOK(TEXTS.longAfterText6, ()=>{
        runText(tIndex + 1);
      });
      return;
    }

    // 文章5：設問kを表示します → OK → 設問を一文字ずつ → はい/いいえ
    showTextWithOK(TEXTS.longQIntro5(qIndex+1), ()=>{
      const [qText, correct] = pack.qs[qIndex];
      flashChars(qText, 80, ()=>{
        showYesNo((pick)=>{
          if(pick === correct) longScore++;
          runQuestion(tIndex, qIndex + 1);
        });
      });
    });
  }
}

function showLongResult(){
  const box = make("div");
  const h = make("h1", { textContent:"スコア" });
  const r = make("div", { className:"result", textContent:`${longScore} / 3` });

  const back = make("button", { textContent:"タイトルへ" });
  back.addEventListener("click", showTitle);

  box.appendChild(h);
  box.appendChild(r);
  box.appendChild(back);

  showCenter(box);
}

/* =========================
   起動
========================= */

showTitle();
